//   12/2/25 - Rev 1 - working code with sudo stock prices on a 8 x 64 array of LED's 
//           Generated partially from perplexity and Claude 
//           Further characterization of current draw on LED's needs to be performed to optimze power supply requirements, currently using 5V/8A (40W) supply
//           Using ESP32-S3 development board with data pin connected to GPIO pin 16, goal is to have this product standalone
//           - Rev 2 - adding Wifi connectivity and real time stock market data
//           - Rev 3 - optimized to use v7 quote API (fetches all stocks in one request)

#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <Adafruit_GFX.h>
#include <Adafruit_NeoMatrix.h>
#include <Adafruit_NeoPixel.h>

// WiFi credentials - CHANGE THESE TO YOUR NETWORK
const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";

#define PIN 16
#define WIDTH 64
#define HEIGHT 8

// Create matrix object for two daisy-chained 32x8 matrices
// This creates a 64x8 display (64 wide, 8 tall)
Adafruit_NeoMatrix matrix = Adafruit_NeoMatrix(
  WIDTH, HEIGHT, PIN,
  NEO_MATRIX_TOP + NEO_MATRIX_LEFT +
  NEO_MATRIX_COLUMNS + NEO_MATRIX_ZIGZAG,
  NEO_GRB + NEO_KHZ800
);

// Stock data structure
struct Stock {
  String symbol;
  float price;
  float changePercent;
};

// Stock symbols to track
Stock stocks[8];
const String stockSymbols[] = {"SPY", "QQQ", "TSM", "VOO", "MU", "NVDA", "GOOGL", "MSFT"};
const int numStocks = 8;

int x = WIDTH;
int currentStock = 0;
char displayText[50];
unsigned long lastUpdate = 0;
const unsigned long updateInterval = 60000; // Update every 60 seconds

void setup() {
  Serial.begin(115200);
  Serial.println("\n\nWiFi Stock Ticker - Real-Time Data (v7 API)");
  
  // Initialize stock symbols
  for (int i = 0; i < numStocks; i++) {
    stocks[i].symbol = stockSymbols[i];
    stocks[i].price = 0.0;
    stocks[i].changePercent = 0.0;
  }
  
  // Initialize matrix
  matrix.begin();
  matrix.setTextWrap(false);
  matrix.setBrightness(30);
  matrix.setTextColor(matrix.Color(0, 255, 100));
  
  // Connect to WiFi
  connectToWiFi();
  
  // Show WiFi status on LED matrix
  if (WiFi.status() == WL_CONNECTED) {
    showMessage("WIFI OK", matrix.Color(0, 255, 0), 2000); // Green, 2 seconds
  } else {
    showMessage("WIFI FAIL", matrix.Color(255, 0, 0), 3000); // Red, 3 seconds
  }
  
  // Initial stock data fetch
  showMessage("FETCHING", matrix.Color(0, 255, 255), 1000); // Cyan, 1 second
  bool success = updateAllStocks();
  
  if (success) {
    showMessage("DATA OK", matrix.Color(0, 255, 0), 2000); // Green, 2 seconds
  } else {
    showMessage("DATA FAIL", matrix.Color(255, 0, 0), 3000); // Red, 3 seconds
  }
}

void loop() {
  // Check if it's time to update stock data
  if (millis() - lastUpdate > updateInterval) {
    updateAllStocks();
    lastUpdate = millis();
  }
  
  // Display stock ticker
  matrix.fillScreen(0);
  
  // Format stock text: "SPY $485.20 +0.74%  "
  snprintf(displayText, sizeof(displayText), "%s $%.2f %+.2f%%  ", 
          stocks[currentStock].symbol.c_str(), 
          stocks[currentStock].price, 
          stocks[currentStock].changePercent);
  
  // Set color based on change
  if (stocks[currentStock].changePercent > 0) {
    matrix.setTextColor(matrix.Color(0, 255, 0));  // Green
  } else if (stocks[currentStock].changePercent < 0) {
    matrix.setTextColor(matrix.Color(255, 0, 0));  // Red
  } else {
    matrix.setTextColor(matrix.Color(255, 255, 0)); // Yellow
  }
  
  matrix.setCursor(x, 0);
  matrix.print(displayText);
  
  // Scroll left
  if(--x < -150) {
    x = matrix.width();
    currentStock = (currentStock + 1) % numStocks;
  }
  
  matrix.show();
  delay(50);
}

void connectToWiFi() {
  Serial.print("Connecting to WiFi");
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 30) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWiFi Connected!");
    Serial.print("IP Address: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("\nWiFi Connection Failed!");
  }
}

void updateAllStocks() {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("WiFi not connected!");
    return false;
  }
  
  Serial.println("Updating stock data...");
  
  HTTPClient http;
  
  // Yahoo Finance v7 quote API - fetches ALL stocks in ONE request!
  String url = "https://query1.finance.yahoo.com/v7/finance/quote?symbols=";
  url += "SPY,QQQ,TSM,VOO,MU,NVDA,GOOGL,MSFT";
  
  Serial.println("Fetching: " + url);
  
  http.begin(url);
  http.addHeader("User-Agent", "Mozilla/5.0");
  http.setTimeout(10000); // 10 second timeout
  
  int httpCode = http.GET();
  
  if (httpCode == 200) {
    String payload = http.getString();
    Serial.println("Response received, parsing JSON...");
    
    // Parse JSON - increased buffer size for multiple stocks
    DynamicJsonDocument doc(16384);
    DeserializationError error = deserializeJson(doc, payload);
    
    if (!error) {
      JsonArray results = doc["quoteResponse"]["result"];
      
      Serial.println("Successfully parsed JSON!");
      Serial.println("Stocks updated:");
      Serial.println("--------------------------------");
      
      for (int i = 0; i < results.size() && i < numStocks; i++) {
        JsonObject stock = results[i];
        
        String symbol = stock["symbol"].as<String>();
        float regularMarketPrice = stock["regularMarketPrice"];
        float regularMarketChangePercent = stock["regularMarketChangePercent"];
        
        // Find matching stock in our array and update
        for (int j = 0; j < numStocks; j++) {
          if (stocks[j].symbol == symbol) {
            stocks[j].price = regularMarketPrice;
            stocks[j].changePercent = regularMarketChangePercent;
            
            Serial.printf("%s: $%.2f (%+.2f%%)\n", 
                         symbol.c_str(), 
                         regularMarketPrice, 
                         regularMarketChangePercent);
            break;
          }
        }
      }
      Serial.println("--------------------------------");
      http.end();
      Serial.println("Stock update complete!\n");
      return true; // Success
    } else {
      Serial.print("JSON parsing failed: ");
      Serial.println(error.c_str());
      Serial.println("Payload preview (first 500 chars):");
      Serial.println(payload.substring(0, 500));
      http.end();
      return false; // Failed
    }
  } else {
    Serial.printf("HTTP Error: %d\n", httpCode);
    if (httpCode > 0) {
      Serial.println("Response: " + http.getString());
    }
    http.end();
    return false; // Failed
  }
}
