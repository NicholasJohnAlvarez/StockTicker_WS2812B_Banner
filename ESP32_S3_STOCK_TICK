//   12/2/25 - Rev 1 - working code with sudo stock prices on a 8 x 64 array of LED's 
//           Generated partially from perplexity and Claude 
//           Further characterization of current draw on LED's needs to be performed to optimze power supply requirements, currently using 5V/8A (40W) supply
//           Using ESP32-S3 development board with data pin connected to GPIO pin 16, goal is to have this product standalone
//           - Rev 2 - adding Wifi connectivity and real time stock market data
//   12/3/25 - Rev 3 - switched to Alpha Vantage API (Yahoo Finance blocked access)

#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <Adafruit_GFX.h>
#include <Adafruit_NeoMatrix.h>
#include <Adafruit_NeoPixel.h>

// WiFi credentials - CHANGE THESE TO YOUR NETWORK
const char* ssid = "YOUR WIFI SSID";
const char* password = "YOUR PWD"; //

// Alpha Vantage API Key - GET FREE KEY AT: https://www.alphavantage.co/support/#api-key
const char* alphaVantageKey = "D080EM8JQ9N8FGMV";  // generated by alphaVantage, can get free key 

#define PIN 16
#define WIDTH 64
#define HEIGHT 8

// Create matrix object for two daisy-chained 32x8 matrices
Adafruit_NeoMatrix matrix = Adafruit_NeoMatrix(
  WIDTH, HEIGHT, PIN,
  NEO_MATRIX_TOP + NEO_MATRIX_LEFT +
  NEO_MATRIX_COLUMNS + NEO_MATRIX_ZIGZAG,
  NEO_GRB + NEO_KHZ800
);

// Stock data structure
struct Stock {
  String symbol;
  float price;
  float changePercent;
  float previousClose;
};

// Stock symbols to track
Stock stocks[8];
const String stockSymbols[] = {"SPY", "QQQ", "TSM", "VOO", "MU", "NVDA", "GOOGL", "MSFT"};
const int numStocks = 8;

int x = WIDTH;
int currentStock = 0;
char displayText[50];
unsigned long lastUpdate = 0;
const unsigned long updateInterval = 300000; // Update every 5 minutes (API rate limit: 25/day free tier)
int currentFetchIndex = 0;

// Function to display a message on the LED matrix
void showMessage(const char* message, uint16_t color, int duration) {
  matrix.fillScreen(0);
  matrix.setTextColor(color);
  matrix.setCursor(0, 0);
  matrix.print(message);
  matrix.show();
  delay(duration);
}

void connectToWiFi() {
  Serial.print("Connecting to WiFi");
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 30) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWiFi Connected!");
    Serial.print("IP Address: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("\nWiFi Connection Failed!");
  }
}

bool fetchSingleStock(int index) {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("WiFi not connected!");
    return false;
  }
  
  String symbol = stockSymbols[index];
  Serial.print("Fetching data for: ");
  Serial.println(symbol);
  
  HTTPClient http;
  
  // Alpha Vantage Global Quote endpoint
  String url = "https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=";
  url += symbol;
  url += "&apikey=";
  url += alphaVantageKey;
  
  Serial.println("URL: " + url);
  
  http.begin(url);
  http.setTimeout(10000);
  
  int httpCode = http.GET();
  
  if (httpCode == 200) {
    String payload = http.getString();
    
    // Parse JSON
    DynamicJsonDocument doc(2048);
    DeserializationError error = deserializeJson(doc, payload);
    
    if (!error) {
      JsonObject globalQuote = doc["Global Quote"];
      
      if (!globalQuote.isNull()) {
        float price = globalQuote["05. price"].as<float>();
        float previousClose = globalQuote["08. previous close"].as<float>();
        float change = price - previousClose;
        float changePercent = (change / previousClose) * 100.0;
        
        // Update stock data
        stocks[index].symbol = symbol;
        stocks[index].price = price;
        stocks[index].previousClose = previousClose;
        stocks[index].changePercent = changePercent;
        
        Serial.printf("%s: $%.2f (%+.2f%%)\n", symbol.c_str(), price, changePercent);
        http.end();
        return true;
      } else {
        Serial.println("Error: API limit reached or invalid response");
        Serial.println(payload);
        http.end();
        return false;
      }
    } else {
      Serial.print("JSON parsing failed: ");
      Serial.println(error.c_str());
      http.end();
      return false;
    }
  } else {
    Serial.printf("HTTP Error: %d\n", httpCode);
    http.end();
    return false;
  }
}

void updateAllStocks() {
  Serial.println("\n=== Updating Stock Data ===");
  
  for (int i = 0; i < numStocks; i++) {
    bool success = fetchSingleStock(i);
    if (!success) {
      Serial.println("Failed to fetch " + stockSymbols[i]);
    }
    // Alpha Vantage free tier: max 25 requests/day, 5 requests/minute
    delay(12000); // 12 second delay between requests (5 per minute limit)
  }
  
  Serial.println("=== Stock Update Complete ===\n");
}

void setup() {
  Serial.begin(115200);
  Serial.println("\n\nESP32 Stock Ticker - Alpha Vantage API");
  Serial.println("Get your free API key at: https://www.alphavantage.co/support/#api-key");
  
  // Initialize stock symbols with default values
  for (int i = 0; i < numStocks; i++) {
    stocks[i].symbol = stockSymbols[i];
    stocks[i].price = 0.0;
    stocks[i].changePercent = 0.0;
    stocks[i].previousClose = 0.0;
  }
  
  // Initialize matrix
  matrix.begin();
  matrix.setTextWrap(false);
  matrix.setBrightness(30);
  matrix.setTextColor(matrix.Color(0, 255, 100));
  
  // Connect to WiFi
  connectToWiFi();
  
  // Show WiFi status on LED matrix
  if (WiFi.status() == WL_CONNECTED) {
    showMessage("WIFI OK", matrix.Color(0, 255, 0), 2000);
  } else {
    showMessage("WIFI FAIL", matrix.Color(255, 0, 0), 3000);
    return; // Don't continue if WiFi failed
  }
  
  // Initial stock data fetch
  showMessage("FETCHING", matrix.Color(0, 255, 255), 1000);
  updateAllStocks();
  showMessage("DATA OK", matrix.Color(0, 255, 0), 2000);
}

void loop() {
  // Check if it's time to update stock data (every 5 minutes)
  if (millis() - lastUpdate > updateInterval) {
    // Fetch one stock at a time to spread out API calls
    Serial.println("Refreshing stock: " + stockSymbols[currentFetchIndex]);
    fetchSingleStock(currentFetchIndex);
    currentFetchIndex = (currentFetchIndex + 1) % numStocks;
    lastUpdate = millis();
  }
  
  // Display stock ticker
  matrix.fillScreen(0);
  
  // Format stock text: "SPY $485.20 +0.74%  "
  if (stocks[currentStock].price > 0) {
    snprintf(displayText, sizeof(displayText), "%s $%.2f %+.2f%%  ", 
            stocks[currentStock].symbol.c_str(), 
            stocks[currentStock].price, 
            stocks[currentStock].changePercent);
  } else {
    snprintf(displayText, sizeof(displayText), "%s LOADING...  ", 
            stocks[currentStock].symbol.c_str());
  }
  
  // Set color based on change
  if (stocks[currentStock].changePercent > 0) {
    matrix.setTextColor(matrix.Color(0, 255, 0));  // Green
  } else if (stocks[currentStock].changePercent < 0) {
    matrix.setTextColor(matrix.Color(255, 0, 0));  // Red
  } else {
    matrix.setTextColor(matrix.Color(255, 255, 0)); // Yellow
  }
  
  matrix.setCursor(x, 0);
  matrix.print(displayText);
  
  // Scroll left
  if(--x < -150) {
    x = matrix.width();
    currentStock = (currentStock + 1) % numStocks;
  }
  
  matrix.show();
  delay(50);
}
