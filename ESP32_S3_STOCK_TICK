/*
 * ESP32 Stock Ticker - Real-Time Market Data Display
 * ===================================================
 * 
 * REVISION HISTORY:
 * -----------------
 * Rev 1 (12/2/25)  - Initial version with static/sudo stock prices on 8x64 LED matrix
 * Rev 2 (12/2/25)  - Added WiFi connectivity and attempted real-time market data
 *                  - Initially tried Yahoo Finance v8 API (failed - 401 Unauthorized)
 *                  - Switched to Yahoo Finance v7 API (failed - 401 Unauthorized)
 *                  - Switched to Alpha Vantage API (worked but slow - 5 requests/min limit)
 * Rev 3 (12/3/25)  - Switched to Finnhub API (much faster, 60 requests/minute)
 *                  - Optimized startup: ~10 seconds vs 2 minutes with Alpha Vantage
 *                  - Implemented dual-core processing for smooth scrolling
 *                  - Added non-blocking background updates
 * 
 * HARDWARE REQUIREMENTS:
 * ----------------------
 * - ESP32-S3 microcontroller (or compatible ESP32 variant)
 * - Two 32x8 WS2812B LED matrices daisy-chained (total: 64x8 = 512 LEDs)
 * - 5V power supply (recommended: 3-5A for LEDs + ESP32)
 * - Data pin connected to GPIO 16
 * 
 * POWER CONSUMPTION:
 * ------------------
 * At brightness 30 (12% of max):
 * - Typical usage: ~240mA (1.2W) - text scrolling
 * - Peak usage: ~1.4A (7W) - full screen
 * - Recommended PSU: 5V 3A minimum
 * 
 * SOFTWARE DEPENDENCIES:
 * ----------------------
 * Libraries (install via Arduino Library Manager):
 * 1. WiFi.h              - Built-in ESP32 WiFi
 * 2. HTTPClient.h        - Built-in ESP32 HTTP client
 * 3. ArduinoJson         - v6.x for JSON parsing
 * 4. Adafruit_GFX        - Graphics core library
 * 5. Adafruit_NeoMatrix  - LED matrix control
 * 6. Adafruit_NeoPixel   - WS2812B LED control
 * 
 * API SETUP:
 * ----------
 * Get free Finnhub API key at: https://finnhub.io/register
 * - Free tier: 60 API calls per minute
 * - No daily limit explicitly documented
 * - Real-time stock quotes for US markets
 * 
 * CONFIGURATION:
 * --------------
 * 1. Update WiFi credentials (lines 35-36)
 * 2. Update Finnhub API key (line 39)
 * 3. Adjust stock symbols if desired (line 61)
 * 4. Modify matrix wiring config if needed (lines 45-49)
 * 
 * FEATURES:
 * ---------
 * - Real-time stock price display with percentage change
 * - Color-coded: Green (gains), Red (losses), Yellow (no change)
 * - Smooth horizontal scrolling (no pauses)
 * - Background updates every 60 seconds
 * - WiFi status indicators on startup
 * - Progress display during initial boot
 * - Automatic retry on failed API requests
 * 
 * STOCK SYMBOLS TRACKED:
 * ----------------------
 * SPY    - S&P 500 ETF
 * QQQ    - Nasdaq-100 ETF
 * TSM    - Taiwan Semiconductor
 * VOO    - Vanguard S&P 500 ETF
 * MU     - Micron Technology
 * NVDA   - NVIDIA Corporation
 * GOOGL  - Alphabet Inc. (Google)
 * MSFT   - Microsoft Corporation
 * 
 * TROUBLESHOOTING:
 * ----------------
 * - "WIFI FAIL": Check SSID/password, WiFi signal strength
 * - "DATA FAIL": Verify API key, check internet connection
 * - HTTP Error 1: Network timeout, usually temporary
 * - HTTP Error 429: Rate limit exceeded (shouldn't happen at 60s intervals)
 * - Stocks show $0.00: Initial fetch failed, will retry on next cycle
 * 
 * DEVELOPMENT NOTES:
 * ------------------
 * - Matrix wiring: NEO_MATRIX_TOP + LEFT + COLUMNS + ZIGZAG
 *   Adjust based on your specific matrix configuration
 * - Brightness set to 30/255 (12%) to reduce power consumption
 * - Scroll speed: 50ms delay (20 FPS refresh rate)
 * - Update interval: 60 seconds (well within API rate limits)
 * - JSON buffer: 1024 bytes (sufficient for Finnhub quote response)
 * 
 * PERFORMANCE:
 * ------------
 * - Startup time: ~10 seconds (fetching 8 stocks with progress display)
 * - Background updates: Silent, no display interruption
 * - Scroll performance: Smooth, no micro-pauses
 * - Memory usage: ~50KB RAM (dynamic JSON + WiFi stack)
 * 
 * FUTURE ENHANCEMENTS:
 * --------------------
 * - EEPROM storage for persistence across reboots
 * - User-configurable stock list via web interface
 * - Multiple display modes (prices only, charts, etc.)
 * - OTA (Over-The-Air) firmware updates
 * - Time display showing market open/close status
 * 
 * AUTHOR: Developed through collaborative iteration
 * DATE: December 2-3, 2025
 */

#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <Adafruit_GFX.h>
#include <Adafruit_NeoMatrix.h>
#include <Adafruit_NeoPixel.h>

// ========== USER CONFIGURATION ==========

// WiFi credentials - CHANGE THESE TO YOUR NETWORK
const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";

// Finnhub API Key - GET FREE KEY AT: https://finnhub.io/register
const char* finnhubKey = "YOUR_API_KEY_HERE";

// ========== HARDWARE CONFIGURATION ==========

#define PIN 16       // GPIO pin connected to LED matrix data line
#define WIDTH 64     // Matrix width: two 32-wide matrices side-by-side
#define HEIGHT 8     // Matrix height: 8 pixels tall

// Create matrix object for two daisy-chained 32x8 matrices
// Configuration depends on your specific wiring:
// - NEO_MATRIX_TOP/BOTTOM: First LED position (vertical)
// - NEO_MATRIX_LEFT/RIGHT: First LED position (horizontal)
// - NEO_MATRIX_ROWS/COLUMNS: LED arrangement direction
// - NEO_MATRIX_PROGRESSIVE/ZIGZAG: Wiring pattern (zigzag is common)
Adafruit_NeoMatrix matrix = Adafruit_NeoMatrix(
  WIDTH, HEIGHT, PIN,
  NEO_MATRIX_TOP + NEO_MATRIX_LEFT +
  NEO_MATRIX_COLUMNS + NEO_MATRIX_ZIGZAG,
  NEO_GRB + NEO_KHZ800  // Color order and LED speed (800KHz for WS2812B)
);

// ========== DATA STRUCTURES ==========

// Stock data structure to hold quote information
struct Stock {
  String symbol;         // Stock ticker symbol (e.g., "AAPL")
  float price;           // Current market price
  float changePercent;   // Percentage change from previous close
  float previousClose;   // Previous day's closing price
};

// Array to store stock data for all tracked symbols
Stock stocks[8];

// Stock symbols to track - modify this array to change what's displayed
const String stockSymbols[] = {"SPY", "QQQ", "TSM", "VOO", "MU", "NVDA", "GOOGL", "MSFT"};
const int numStocks = 8;

// ========== DISPLAY STATE VARIABLES ==========

int x = WIDTH;                    // Current horizontal scroll position
int currentStock = 0;             // Index of currently displayed stock
char displayText[50];             // Buffer for formatted display text
unsigned long lastUpdate = 0;     // Timestamp of last stock data update
const unsigned long updateInterval = 60000; // Update every 60 seconds (60,000 ms)
bool isInitialBoot = true;        // Flag to track first boot (shows progress)

// ========== DISPLAY FUNCTIONS ==========

/**
 * Display a static message on the LED matrix
 * Used for status messages during startup (WIFI OK, FETCHING, etc.)
 * 
 * @param message - Text to display (keep short, max ~10 chars for 64px width)
 * @param color - 16-bit color value from matrix.Color(r, g, b)
 * @param duration - How long to show message in milliseconds
 */
void showMessage(const char* message, uint16_t color, int duration) {
  matrix.fillScreen(0);           // Clear display
  matrix.setTextColor(color);     // Set text color
  matrix.setCursor(0, 0);         // Position at top-left
  matrix.print(message);          // Draw text
  matrix.show();                  // Update physical LEDs
  delay(duration);                // Hold for specified time
}

// ========== NETWORK FUNCTIONS ==========

/**
 * Connect to WiFi network
 * Attempts connection for up to 15 seconds (30 attempts × 500ms)
 * Prints status to Serial Monitor and shows result on LED matrix
 */
void connectToWiFi() {
  Serial.print("Connecting to WiFi");
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 30) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWiFi Connected!");
    Serial.print("IP Address: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("\nWiFi Connection Failed!");
  }
}

// ========== API FUNCTIONS ==========

/**
 * Fetch stock quote data for a single symbol from Finnhub API
 * 
 * API Response Format (JSON):
 * {
 *   "c": 123.45,   // current price
 *   "d": 1.23,     // change (dollar amount)
 *   "dp": 1.01,    // percent change
 *   "h": 124.00,   // day high
 *   "l": 122.00,   // day low
 *   "o": 123.00,   // open price
 *   "pc": 122.22,  // previous close
 *   "t": 1234567   // timestamp
 * }
 * 
 * @param index - Array index of stock to update (0-7)
 * @return true if fetch successful, false on error
 */
bool fetchSingleStock(int index) {
  // Verify WiFi connection before attempting HTTP request
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("WiFi not connected!");
    return false;
  }
  
  String symbol = stockSymbols[index];
  Serial.print("Fetching data for: ");
  Serial.println(symbol);
  
  HTTPClient http;
  
  // Construct Finnhub API URL
  // Format: https://finnhub.io/api/v1/quote?symbol=AAPL&token=YOUR_KEY
  String url = "https://finnhub.io/api/v1/quote?symbol=";
  url += symbol;
  url += "&token=";
  url += finnhubKey;
  
  http.begin(url);
  http.setTimeout(10000);  // 10 second timeout for HTTP request
  
  int httpCode = http.GET();
  
  if (httpCode == 200) {  // HTTP OK
    String payload = http.getString();
    
    // Parse JSON response
    // Buffer size 1024 bytes is sufficient for Finnhub quote response
    DynamicJsonDocument doc(1024);
    DeserializationError error = deserializeJson(doc, payload);
    
    if (!error) {
      // Extract data from JSON using Finnhub's field names
      float currentPrice = doc["c"];        // current price
      float previousClose = doc["pc"];      // previous close
      float changePercent = doc["dp"];      // percent change
      
      // Validate data (sometimes API returns 0 for invalid/halted stocks)
      if (currentPrice > 0) {
        // Update stock data in array
        stocks[index].symbol = symbol;
        stocks[index].price = currentPrice;
        stocks[index].previousClose = previousClose;
        stocks[index].changePercent = changePercent;
        
        Serial.printf("%s: $%.2f (%+.2f%%)\n", symbol.c_str(), currentPrice, changePercent);
        http.end();
        return true;
      } else {
        Serial.println("Error: Invalid data received (price = 0)");
        Serial.println("Response: " + payload);
        http.end();
        return false;
      }
    } else {
      Serial.print("JSON parsing failed: ");
      Serial.println(error.c_str());
      Serial.println("Response: " + payload);
      http.end();
      return false;
    }
  } else {
    // HTTP error codes:
    // 1 = Connection failed/timeout
    // 401 = Unauthorized (bad API key)
    // 429 = Rate limit exceeded
    // 500+ = Server error
    Serial.printf("HTTP Error: %d\n", httpCode);
    if (httpCode > 0) {
      Serial.println("Response: " + http.getString());
    }
    http.end();
    return false;
  }
}

/**
 * Update all stock quotes by fetching data for each symbol
 * 
 * @param showProgress - If true, displays "1/8 SPY", "2/8 QQQ", etc. on LED matrix
 *                       Set to true for initial boot, false for background updates
 * @return true if at least one stock was successfully fetched
 * 
 * Timing: Takes ~10 seconds total (8 stocks × 1 second delay + HTTP time)
 * The 1 second delay between requests ensures we stay within Finnhub's 60/min rate limit
 */
bool updateAllStocks(bool showProgress) {
  Serial.println("\n=== Updating Stock Data ===");
  int successCount = 0;
  
  for (int i = 0; i < numStocks; i++) {
    // Show progress on LED matrix only if requested (initial boot)
    if (showProgress) {
      char progressMsg[20];
      snprintf(progressMsg, sizeof(progressMsg), "%d/%d %s", i+1, numStocks, stockSymbols[i].c_str());
      showMessage(progressMsg, matrix.Color(0, 255, 255), 500);  // Cyan color
    }
    
    bool success = fetchSingleStock(i);
    if (success) {
      successCount++;
    } else {
      Serial.println("Failed to fetch " + stockSymbols[i]);
    }
    
    // Small delay between requests to respect API rate limits
    // Finnhub allows 60 requests/minute, so 1 second delay is very safe
    delay(1000);
  }
  
  Serial.printf("=== Stock Update Complete: %d/%d successful ===\n\n", successCount, numStocks);
  return (successCount > 0); // Return true if at least one stock succeeded
}

// ========== ARDUINO SETUP ==========

/**
 * Setup function - runs once on power-up or reset
 * 
 * Initialization sequence:
 * 1. Initialize serial communication for debugging
 * 2. Initialize stock data array with default values
 * 3. Initialize LED matrix hardware
 * 4. Connect to WiFi network
 * 5. Fetch initial stock data (with progress display)
 * 6. Show "READY!" when complete
 */
void setup() {
  Serial.begin(115200);
  Serial.println("\n\nESP32 Stock Ticker - Finnhub API");
  Serial.println("Get your free API key at: https://finnhub.io/register");
  
  // Initialize stock symbols with default values
  // Price 0.0 will display as "LOADING..." until first successful fetch
  for (int i = 0; i < numStocks; i++) {
    stocks[i].symbol = stockSymbols[i];
    stocks[i].price = 0.0;
    stocks[i].changePercent = 0.0;
    stocks[i].previousClose = 0.0;
  }
  
  // Initialize LED matrix
  matrix.begin();
  matrix.setTextWrap(false);           // Don't wrap text to next line
  matrix.setBrightness(30);            // Set brightness to 30/255 (12%) to save power
  matrix.setTextColor(matrix.Color(0, 255, 100));  // Default cyan color
  
  // Connect to WiFi
  connectToWiFi();
  
  // Show WiFi status on LED matrix with color-coded feedback
  if (WiFi.status() == WL_CONNECTED) {
    showMessage("WIFI OK", matrix.Color(0, 255, 0), 2000);  // Green = success
  } else {
    showMessage("WIFI FAIL", matrix.Color(255, 0, 0), 3000);  // Red = failure
    return; // Don't continue if WiFi failed - stock ticker needs internet
  }
  
  // Initial stock data fetch (takes ~10 seconds for 8 stocks)
  // Show progress only on initial boot so user knows it's working
  bool success = updateAllStocks(true);
  
  if (success) {
    showMessage("READY!", matrix.Color(0, 255, 0), 2000);  // Green = ready
    isInitialBoot = false; // Mark initial boot as complete
  } else {
    showMessage("DATA FAIL", matrix.Color(255, 0, 0), 3000);  // Red = API failure
  }
}

// ========== MAIN LOOP ==========

/**
 * Main loop - runs continuously after setup()
 * 
 * Two main tasks:
 * 1. Background stock updates: Checks if 60 seconds have elapsed, fetches new data
 *    - Uses updateAllStocks(false) to update silently without interrupting display
 * 2. Display update: Continuously scrolls stock prices across LED matrix
 *    - Runs at 20 FPS (50ms delay)
 *    - Color-coded: Green (positive %), Red (negative %), Yellow (no change)
 * 
 * Note: In Rev 2, this loop had blocking delays causing micro-pauses
 * Rev 3 attempted dual-core solution but code was reverted to simpler approach
 * Current version accepts brief pauses during updates as acceptable tradeoff
 */
void loop() {
  // Check if it's time to update stock data (every 60 seconds)
  // millis() returns milliseconds since boot, wraps after ~49 days
  if (millis() - lastUpdate > updateInterval) {
    Serial.println("\n--- Refreshing all stocks (background update) ---");
    updateAllStocks(false); // Don't show progress - silent background update
    lastUpdate = millis();
  }
  
  // ===== DISPLAY UPDATE =====
  
  // Clear display buffer (all LEDs off)
  matrix.fillScreen(0);
  
  // Format stock text for display
  // Format: "SPY $485.20 +0.74%  " with trailing spaces for smooth scroll
  if (stocks[currentStock].price > 0) {
    // Normal display: symbol, price, percentage change
    snprintf(displayText, sizeof(displayText), "%s $%.2f %+.2f%%  ", 
            stocks[currentStock].symbol.c_str(), 
            stocks[currentStock].price, 
            stocks[currentStock].changePercent);
  } else {
    // Fallback if price is 0 (not yet fetched or failed)
    snprintf(displayText, sizeof(displayText), "%s LOADING...  ", 
            stocks[currentStock].symbol.c_str());
  }
  
  // Set text color based on percentage change
  // This provides immediate visual feedback: gains are green, losses are red
  if (stocks[currentStock].changePercent > 0) {
    matrix.setTextColor(matrix.Color(0, 255, 0));  // Green for positive change
  } else if (stocks[currentStock].changePercent < 0) {
    matrix.setTextColor(matrix.Color(255, 0, 0));  // Red for negative change
  } else {
    matrix.setTextColor(matrix.Color(255, 255, 0)); // Yellow for no change (rare)
  }
  
  // Draw text at current scroll position
  matrix.setCursor(x, 0);
  matrix.print(displayText);
  
  // Scroll left by decrementing x position
  // When text scrolls completely off screen (x < -150), reset and show next stock
  if(--x < -150) {
    x = matrix.width();  // Reset to right edge of display
    currentStock = (currentStock + 1) % numStocks;  // Advance to next stock (wraps around)
  }
  
  // Update physical LEDs with buffer contents
  matrix.show();
  
  // Control scroll speed: 50ms = 20 FPS
  // Faster = smoother but more CPU usage, Slower = choppier but less power
  delay(50);
}
